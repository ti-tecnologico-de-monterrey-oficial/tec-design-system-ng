<section class="bmb_timestream" [ngStyle]="{ height: getHeight() }">
  @if (error) {
    <div class="bmb_timestream-error">
      <bmb-timestream-error />
    </div>
  } @else {
    <aside class="bmb_timestream-aside">
      <bmb-timestream-timeline
        [dateFormat]="dateFormat()"
        [lang]="lang()"
        [now]="now"
        [events]="parsedEvents"
        [selectedDate]="selectedDate"
        [orderedMonths]="orderedMonths"
        (changeSelectedDate)="handleSelectedDateChange($event)"
      />
    </aside>
    <section class="bmb_timestream-main">
      <bmb-timestream-detail
        [lang]="lang()"
        [now]="now"
        [selectedDate]="selectedDate"
        (changeSelectedEvent)="handleSelectedEventChange($event)"
        [orderedEvents]="orderedEvents()"
      />
    </section>
  }
</section>

<ng-template #modalTemplate>
  @if (selectedEvent) {
    <section class="bmb_timestream-dialog">
      <figure class="bmb_timestream-dialog-hero">
        <img
          [src]="selectedEvent.image"
          [alt]="selectedEvent.title"
          class="bmb_timestream-dialog-hero-image"
        />
      </figure>
      <div class="bmb_timestream-dialog-user">
        <bmb-user-image
          size="mobile-small"
          [image]="selectedEvent.picture_profile || ''"
          [altImage]="selectedEvent.user_first_name || ''"
          [bordered]="false"
        />
        <span class="bmb_timestream-dialog-user-name"
          >{{ selectedEvent.user_first_name }}
          {{ selectedEvent.user_last_name }}</span
        >
        <span class="bmb_timestream-dialog-user-date">{{
          selectedEvent.startEvent?.toFormat("dd/MM/yyyy")
        }}</span>
      </div>
      <bmb-tabs
        [tabs]="eventTabs"
        (selected)="handleTabSelected($event)"
        style="flex: 1"
      >
        @switch (tabSelected) {
          @case (1) {
            <div class="bmb_timestream-dialog-tab">
              <p>{{ selectedEvent.description }}</p>
            </div>
          }
          @case (2) {
            <div class="bmb_timestream-dialog-tab">
              <h3 class="bmb_timestream-dialog-tab-title">Instancias</h3>
              <bmb-divider type="simple" />
              <section class="bmb_timestream-dialog-tab-hito-list">
                @for (date of getInstances(selectedEvent); track $index) {
                  <bmb-hito-card
                    [icon]="selectedEvent.icon || 'app_badging'"
                    [title]="selectedEvent.title"
                    [type]="selectedEvent.type"
                    [id]="$index"
                    [enable_bullet]="false"
                    [alternative_appearance]="true"
                  />
                }
                @if (selectedEvent.diff) {
                  <p class="bmb_timestream-dialog-tab-duration">
                    {{ getDurationString(selectedEvent) }}
                  </p>
                }
                @if (selectedEvent.related_to) {
                  <h3 class="bmb_timestream-dialog-container-tab-title">
                    Relacionado a
                  </h3>
                  @for (related of selectedEvent.related_to; track $index) {
                    <bmb-hito-card
                      [icon]="selectedEvent.icon || 'app_badging'"
                      [title]="related"
                      [type]="selectedEvent.type"
                      [id]="related"
                      [enable_bullet]="false"
                      [alternative_appearance]="true"
                    />
                  }
                }
              </section>
            </div>
          }
        }
      </bmb-tabs>
      <section class="bmb_timestream-dialog-button-container">
        <button bmbButton appearance="primary" icon="fit_screen">
          Ir a decisi√≥n
        </button>
      </section>
    </section>
  }
</ng-template>
